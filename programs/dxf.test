#!/bin/bash
# dxf.test
#
# Copyright (C) 2018 Free Software Foundation, Inc.
#
# This program is free software, licensed under the terms of the GNU
# General Public License as published by the Free Software Foundation,
# either version 3 of the License, or (at your option) any later version.
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.
#
# test DXF specific content
# Author: Reini Urban

if [ -d test/test-data ]; then cd ..; fi
datadir=${datadir:-../test/test-data}
problems=0
#DATA="sample_2000 example_2000 example_2004 example_2007 example_2010"
#DATA="$DATA example_2013 example_2018 example_r14"
#TODO="r11/ACEL10"
#
#for d in $DATA; do
#    b=$(basename $d)
#    rm $b.dxf 2>/dev/null
#done

# check subentity owners
for year in r14 2000 2004 2007 2010 2013 2018
do
    for base in PolyLine3D PolyLine2D
    do
        dwg=$datadir/${year}/${base}.dwg
        dxf=$datadir/${year}/${base}.dxf
        tgt=../${base}_${year}.dxf
        log=../${base}_${year}.log
        if [ -f $dwg ] && [ -f $dxf ]; then
            ../libtool --mode=execute ./dwg2dxf -v4 -o $tgt $dwg 2>$log
            diff -bu <(grep -A8 ^VERTEX $dxf) <(grep -A8 ^VERTEX $tgt)
            diff -bu <(grep -A8 ^SEQEND $dxf) <(grep -A8 ^SEQEND $tgt)
            diff -bu <(grep -A8 ^POLYLINE $dxf) <(grep -A8 ^POLYLINE $tgt) && \
              echo $tgt ok
#        else
#            echo skip $dxf missing
        fi
    done
done
for year in r14 2000 2004 2007 2010 2013 2018
do
    for base in example Drawing
    do
        dwg=$datadir/${base}_${year}.dwg
        dxf=$datadir/${base}_${year}.dxf
        tgt=../${base}_${year}.dxf
        log=../${base}_${year}.log
        if [ -f $dwg ] && [ -f $dxf ]; then
            ../libtool --mode=execute ./dwg2dxf -v4 -o $tgt $dwg 2>$log
            diff -bu <(grep -A8 ^VERTEX $dxf) <(grep -A8 ^VERTEX $tgt)
            diff -bu <(grep -A8 ^SEQEND $dxf) <(grep -A8 ^SEQEND $tgt)
            diff -bu <(grep -A8 ^POLYLINE $dxf) <(grep -A8 ^POLYLINE $tgt) && \
              echo $tgt ok
#        else
#            echo skip $dxf missing
        fi
    done
done

#for dwg in $DATA; do
#    dxf=`basename $dwg .dwg`.dxf
#    dwg=${datadir}/$dwg.dwg
#    echo dwg2dxf -o$dxf $dwg
#    if ../libtool --mode=execute ./dwg2dxf -o$dxf $dwg; then
#        rm $dxf.log $dxf
#        echo ok
#    else
#        cat $dxf.log
#        problems=$(expr 1 + $problems)
#    fi
#done

if test x0 = x$problems ; then
    exit 0
else
    echo `basename $0`: $problems failures
    ls -l *dxf.log
    exit 1
fi
